---
title: "parseq: sensitivity analyses on sequences of parameters for mrgsolve"
output: github_document
---


A simple, clean workflow for simulating from a model across 
sequences of parameters.  

<hr>
<BR>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, comment = '.', 
                      fig.path = "inst/img/README-")
```

```{r}
library(parseq)
```



```{r}
mod <- mread("pk1", modlib(), end = 48, delta = 0.1)

param(mod)
```

## PK model sensitivity analysis by factor

The nominal (in model) parameter value is divided 
and multiplied by a factor, generating minimum and maximum 
bounds for simulating a sequence of parameter values

```{r}
mod %>% 
  ev(amt = 100) %>% 
  parseq_factor(CL, V, .n=8) %>% 
  sens_each() %>% 
  sens_plot(CP)
```

## HIV viral dynamic model

We look at latent infected cell pool development over ten years at different 
"burst" size, or the number of HIV particles released when one cell lyses.  


```{r}
mod <- mread("hiv", "inst/example")

mod %>% 
  update(end = 365*10) %>%
  parseq_range(N = c(900,1500), .n = 10) %>%
  sens_each(tscale = 1/365) %>% 
  sens_plot(L)
```


## Sensitivity analysis on custom sequences

The model is rifampicin PBPK.

```{r}
mod <- mread("inst/example/rifampicin.cpp") %>% update(delta = 0.1)

mod %>% 
  ev(amt = 600) %>% 
  parseq_manual(
    SFKp = fct_seq(.$SFKp, .n = 20), 
    Kp_muscle = even_seq(0.001, 0.1, .n = 6)
  ) %>% 
  sens_each() %>% 
  sens_plot(Ccentral, bw = TRUE)
```

# Simulate a grid

To this point, we have always used `sens_each` so that each value for each 
parameter is simulated one at a time.  Now, simulate the grid or all 
combinations.

```{r, fig.height = 9}
library(ggplot2)

mod %>% 
  ev(amt = 600) %>% 
  parseq_cv(fBCLint_all_kg, SFKp, Kp_muscle, .n = 4, .cv = 50) %>% 
  sens_grid() %>% 
  sens_plot(Ccentral)
```

