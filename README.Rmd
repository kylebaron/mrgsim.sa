---
title: "mrgsim.sa: sensitivity analysis with mrgsolve"
output: github_document
---


A simple, clean workflow for sensitivity analysis with mrgsolve. 
<hr>
<BR>

```{r, include = FALSE}
knitr::opts_chunk$set(
  comment = ".",
  fig.path = "man/figures/README-"
)
options(tibble.print_min = 5, tibble.print_max = 5)
```

```{r}
library(mrgsim.sa)
```



```{r}
mod <- mread("pk1", modlib(), end = 48, delta = 0.1)

param(mod)
```

## PK model sensitivity analysis by factor

The nominal (in model) parameter value is divided 
and multiplied by a factor, generating minimum and maximum 
bounds for simulating a sequence of parameter values

```{r}
out <- 
  mod %>% 
  ev(amt = 100) %>% 
  parseq_factor(CL, V, .n=8) %>% 
  sens_each() 

sens_plot(out, "CP")
```

The simulated data is returned in a long format
```{r}
out
```



## HIV viral dynamic model

We look at latent infected cell pool development over ten years at different 
"burst" size, or the number of HIV particles released when one cell lyses.  


```{r}
mod <- mread("hiv", "inst/example")

mod %>% 
  update(end = 365*10) %>%
  parseq_range(N = c(900,1500), .n = 10) %>%
  sens_each(tscale = 1/365) %>% 
  sens_plot("L")
```


## Sensitivity analysis on custom sequences

The model is rifampicin PBPK.

```{r}
mod <- mread("inst/example/rifampicin.cpp") %>% update(delta = 0.1)

mod %>% 
  ev(amt = 600) %>% 
  parseq_manual(
    SFKp = fct_seq(.$SFKp, n = 20), 
    Kp_muscle = even_seq(0.001, 0.1, n = 6)
  ) %>% 
  sens_each() %>% 
  sens_plot("Ccentral")
```

# Simulate a grid

To this point, we have always used `sens_each` so that each value for each 
parameter is simulated one at a time.  Now, simulate the grid or all 
combinations.

We use `parseq_cv` here, which generates lower and upper bounds
for the range using 50% coefficient of variation.

```{r, fig.height = 9}
library(ggplot2)

mod %>% 
  ev(amt = 600) %>% 
  parseq_cv(fBCLint_all_kg, SFKp, Kp_muscle, .n = 4, .cv = 50) %>% 
  sens_grid() %>% 
  sens_plot("Ccentral")
```

# Local sensitivity analysis

```{r}
mod <- modlib("pk2", delta = 0.1, end = 72)

doses <- ev(amt = 100)

out <- lsa(mod, var = "CP", par = "CL,V2,Q", events = doses)

plot(out)
```

